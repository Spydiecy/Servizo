<div class="dashboard-section">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="sidebar-content">
                    <div class="user-info">
                        <div class="user-avatar-large">
                            <i class="fas fa-user"></i>
                        </div>
                        <h5><%= user.fullName %></h5>
                        <span class="badge badge-<%= user.userType === 'provider' ? 'success' : 'primary' %>">
                            <%= user.userType === 'provider' ? 'Service Provider' : 'Customer' %>
                        </span>
                    </div>
                    
                    <nav class="sidebar-nav">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="/dashboard">
                                    <i class="fas fa-tachometer-alt"></i>
                                    Dashboard
                                </a>
                            </li>
                            <% if (user.userType === 'customer') { %>
                                <li class="nav-item">
                                    <a class="nav-link" href="/bookings">
                                        <i class="fas fa-calendar-check"></i>
                                        My Bookings
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/services">
                                        <i class="fas fa-search"></i>
                                        Find Services
                                    </a>
                                </li>
                            <% } else { %>
                                <li class="nav-item">
                                    <a class="nav-link" href="/my-services">
                                        <i class="fas fa-tools"></i>
                                        My Services
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/bookings/manage">
                                        <i class="fas fa-calendar-alt"></i>
                                        Manage Bookings
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/earnings">
                                        <i class="fas fa-chart-line"></i>
                                        Earnings
                                    </a>
                                </li>
                            <% } %>
                            <li class="nav-item">
                                <a class="nav-link" href="/profile">
                                    <i class="fas fa-user-cog"></i>
                                    Profile Settings
                                </a>
                            </li>
                            <li class="nav-item mt-3">
                                <a class="nav-link text-danger" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="dashboard-header">
                    <h2>Welcome back, <%= user.firstName %>!</h2>
                    <p class="text-muted">Here's what's happening with your account today.</p>
                </div>
                
                <!-- Account Info Cards -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="info-content">
                                <h6>Account Type</h6>
                                <p><%= user.userType === 'provider' ? 'Service Provider' : 'Customer' %></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="info-content">
                                <h6>Member Since</h6>
                                <p><%= new Date(user.createdAt).toLocaleDateString() %></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="info-content">
                                <h6>Email</h6>
                                <p><%= user.email %></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="info-card">
                            <div class="info-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="info-content">
                                <h6>Phone</h6>
                                <p><%= user.phone %></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <% if (user.userType === 'customer') { %>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <a href="/services" class="action-card">
                                                <div class="action-icon">
                                                    <i class="fas fa-search"></i>
                                                </div>
                                                <h6>Find Services</h6>
                                                <p>Browse and book home services</p>
                                            </a>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <a href="/bookings" class="action-card">
                                                <div class="action-icon">
                                                    <i class="fas fa-calendar-check"></i>
                                                </div>
                                                <h6>My Bookings</h6>
                                                <p>View your service bookings</p>
                                            </a>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <a href="/profile" class="action-card">
                                                <div class="action-icon">
                                                    <i class="fas fa-user-edit"></i>
                                                </div>
                                                <h6>Update Profile</h6>
                                                <p>Edit your account information</p>
                                            </a>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <!-- Service Provider Actions -->
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <a href="#" class="action-card" onclick="showCreateServiceModal()">
                                                <div class="action-icon">
                                                    <i class="fas fa-plus"></i>
                                                </div>
                                                <h6>Create Service</h6>
                                                <p>Add new service offerings</p>
                                            </a>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <a href="#" class="action-card" onclick="loadMyServices()">
                                                <div class="action-icon">
                                                    <i class="fas fa-tools"></i>
                                                </div>
                                                <h6>My Services</h6>
                                                <p>Manage your services</p>
                                            </a>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <a href="/bookings/manage" class="action-card">
                                                <div class="action-icon">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </div>
                                                <h6>Manage Bookings</h6>
                                                <p>Handle customer requests</p>
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <!-- Services Management Section -->
                                    <div id="servicesSection" class="mt-4" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5>My Services</h5>
                                            <button class="btn btn-primary" onclick="showCreateServiceModal()">
                                                <i class="fas fa-plus"></i> Add New Service
                                            </button>
                                        </div>
                                        <div id="servicesList" class="row">
                                            <!-- Services will be loaded here -->
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Service Modal -->
<div class="modal fade" id="createServiceModal" tabindex="-1" aria-labelledby="createServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createServiceModalLabel">Create New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createServiceForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="title" class="form-label">Service Title</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-control" id="category" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="cleaning">Cleaning</option>
                                    <option value="ac">AC Services</option>
                                    <option value="plumbing">Plumbing</option>
                                    <option value="electrical">Electrical</option>
                                    <option value="painting">Painting</option>
                                    <option value="beauty">Beauty</option>
                                    <option value="appliance">Appliance Repair</option>
                                    <option value="pest-control">Pest Control</option>
                                    <option value="home-repair">Home Repair</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="price" class="form-label">Price (₹)</label>
                                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="priceType" class="form-label">Price Type</label>
                                <select class="form-control" id="priceType" name="priceType">
                                    <option value="fixed">Fixed Price</option>
                                    <option value="hourly">Per Hour</option>
                                    <option value="per-visit">Per Visit</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="duration" class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="duration" name="duration" min="15" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serviceCity" class="form-label">Service City</label>
                                <input type="text" class="form-control" id="serviceCity" name="serviceCity" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subcategory" class="form-label">Subcategory (Optional)</label>
                                <input type="text" class="form-control" id="subcategory" name="subcategory">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="features" class="form-label">Features (comma-separated)</label>
                        <input type="text" class="form-control" id="features" name="features" placeholder="Professional tools, Experienced staff, Quality guarantee">
                    </div>
                    
                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="tags" name="tags" placeholder="professional, affordable, reliable">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Service Management Functions
async function showCreateServiceModal() {
    const modal = new bootstrap.Modal(document.getElementById('createServiceModal'));
    modal.show();
}

async function loadMyServices() {
    try {
        const response = await fetch('/services/provider/my');
        const data = await response.json();
        
        if (data.success) {
            displayServices(data.services);
            document.getElementById('servicesSection').style.display = 'block';
        } else {
            alert('Error loading services: ' + data.message);
        }
    } catch (error) {
        console.error('Error loading services:', error);
        alert('Error loading services');
    }
}

function displayServices(services) {
    const servicesList = document.getElementById('servicesList');
    
    if (services.length === 0) {
        servicesList.innerHTML = `
            <div class="col-12">
                <div class="text-center py-4">
                    <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                    <h5>No Services Yet</h5>
                    <p class="text-muted">Create your first service to get started!</p>
                    <button class="btn btn-primary" onclick="showCreateServiceModal()">
                        <i class="fas fa-plus"></i> Create Service
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    servicesList.innerHTML = services.map(service => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card service-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title">${service.title}</h6>
                        <span class="badge ${service.isActive ? 'bg-success' : 'bg-secondary'}">
                            ${service.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <p class="card-text text-muted small">${service.description.substring(0, 100)}...</p>
                    <div class="service-details">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary">${service.category}</span>
                            <strong class="text-primary">₹${service.price}</strong>
                        </div>
                        <div class="text-muted small">
                            <i class="fas fa-clock"></i> ${Math.floor(service.duration / 60)}h ${service.duration % 60}m
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editService('${service._id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-${service.isActive ? 'warning' : 'success'}" 
                                    onclick="toggleServiceStatus('${service._id}')">
                                <i class="fas fa-toggle-${service.isActive ? 'on' : 'off'}"></i> 
                                ${service.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteService('${service._id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Handle create service form submission
document.getElementById('createServiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const serviceData = {
        title: formData.get('title'),
        description: formData.get('description'),
        category: formData.get('category'),
        subcategory: formData.get('subcategory'),
        price: formData.get('price'),
        priceType: formData.get('priceType'),
        duration: formData.get('duration'),
        features: formData.get('features'),
        tags: formData.get('tags'),
        serviceArea: {
            city: formData.get('serviceCity')
        }
    };
    
    try {
        const response = await fetch('/services', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(serviceData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Service created successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('createServiceModal'));
            modal.hide();
            this.reset();
            loadMyServices(); // Reload services
        } else {
            alert('Error creating service: ' + data.message);
        }
    } catch (error) {
        console.error('Error creating service:', error);
        alert('Error creating service');
    }
});

async function toggleServiceStatus(serviceId) {
    try {
        const response = await fetch(`/services/${serviceId}/toggle`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            loadMyServices(); // Reload services
        } else {
            alert('Error updating service: ' + data.message);
        }
    } catch (error) {
        console.error('Error updating service:', error);
        alert('Error updating service');
    }
}

async function deleteService(serviceId) {
    if (!confirm('Are you sure you want to delete this service? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/services/${serviceId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Service deleted successfully!');
            loadMyServices(); // Reload services
        } else {
            alert('Error deleting service: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting service:', error);
        alert('Error deleting service');
    }
}

function editService(serviceId) {
    // TODO: Implement edit functionality
    alert('Edit functionality coming soon!');
}

async function logout() {
    try {
        const response = await fetch('/auth/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            window.location.href = '/';
        } else {
            alert('Error logging out');
        }
    } catch (error) {
        console.error('Logout error:', error);
        alert('Error logging out');
    }
}
</script>